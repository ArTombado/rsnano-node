@startuml "Confirmation Height"
class UnboundedMode {
    process(block, callbacks)
}

class BoundedMode{
    process(block, callbacks)
}

class AutomaticMode{
    process(block, callbacks)
}

class ConfirmationHeightProcessor{
    add(block)
    run(mode)
}

package "Infrastructure" {
    class Ledger
}

package "Logic"{
    enum ConfirmationHeightMode{
        Autmatic
        Unbounded
        Bounded
    }

    struct WriteDetails{
        account
        bottom_height
        bottom_hash
        top_height
        top_hash
    }
    class WriteDetailsQueue

    class SingleAccountCementer
    class MultiAccountCementer
    class BatchWriteSizeManager {
        current()
    }

    interface CementationDataRequester{
        get_block(hash)
        was_block_pruned(hash)
        get_current_confirmation_height(account)
        get_account_info(account)
        refresh_transaction()
    }

    struct BoundedCementationStep{
        is_done
        already_cemented
        write_details
    }
}

package "Values"{
    struct UpdateConfirmationHeight{
        account
        new_cemented_frontier
        new_height
        num_blocks_cemented
    }
}

package "Application"{
    class CementationLedgerAdapter
}

class BoundedModeHelper{
    initialize(hash)
    get_next_step()
}

Ledger ..> UpdateConfirmationHeight

UnboundedMode --> Ledger
UnboundedMode --> BatchWriteSizeManager

BoundedMode --> Ledger
BoundedMode --> MultiAccountCementer
BoundedMode --> BatchWriteSizeManager
BoundedMode --> CementationLedgerAdapter
BoundedMode --> BoundedModeHelper

BoundedModeHelper --> BoundedCementationStep: creates

BoundedCementationStep --> WriteDetails

MultiAccountCementer --> SingleAccountCementer
MultiAccountCementer --> BatchWriteSizeManager
MultiAccountCementer --> WriteDetailsQueue
MultiAccountCementer --> CementationDataRequester

SingleAccountCementer --> UpdateConfirmationHeight
SingleAccountCementer --> WriteDetails: creates

WriteDetailsQueue --> WriteDetails

AutomaticMode --> ConfirmationHeightMode
AutomaticMode --> BoundedMode
AutomaticMode --> UnboundedMode
AutomaticMode --> Ledger
AutomaticMode --> BatchWriteSizeManager

ConfirmationHeightProcessor --> AutomaticMode

CementationLedgerAdapter ..|> CementationDataRequester
CementationLedgerAdapter --> Ledger

@enduml